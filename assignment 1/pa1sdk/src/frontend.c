#include "tokens.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>
#define STACK_MAX 100

extern int yylex(void);
extern FILE *yyin;



struct _Stack{
      int data[STACK_MAX];
      int size;
};
typedef struct _Stack Stack;

void Stack_Push(Stack *s, int d);
int Stack_Pop(Stack *s, int d);

char *toknames[] = {"ID","NUM","STR","VAR","COMMA","PERIOD","COLON","SEMICOLON","LPAREN","RPAREN","LSQUARE",
                    "RSQUARE","LCURLY","RCURLY","PLUS","MINUS","DIVIDE","MOD","MULTIPLY","OR","AND","LESSEQ","GREATEREQ", 
                    "EQEQ","NOTEQ", "LESS","GREATER", "EQ","NOT","IF","COMMENT","LMULTICOMMENT","RMULTICOMMENT","TYPE","INT",
                    "BOOL","ELSE","FOR","TO","WHILE","NIL","TRU", "FALS","MAIN","FUNCTION","RETURN","NEWLINE","BADTOKEN"};

int main(int argc, char** argv) 
{
      char *fname;
      int tok;
      int numTok = 0;
      int mainFlag = 0;
      int brackFlag = 0;
      int lineNum = 1;
      Stack *bracketStack = malloc(sizeof(Stack));
      bracketStack->size = 0;

      if(argc != 2)
      {
      	printf("Wrong number of files!");
      	return 0;
      }

      fname = argv[1];
      yyin = fopen(fname,"r");
      if(yyin == NULL)
      {
      	printf("file unreadable");
      	return 0;
      }
      
      
      for(;;)
      {
            tok = yylex();
            if(tok==0)
                  break;
            numTok++;
            switch(tok)
            {
                  case MAIN:
                        {
                              mainFlag = 1;
                              break;
                        }
                  case LPAREN:
                        {
                              Stack_Push(bracketStack,LPAREN);
                              break;
                        }
                  case RPAREN:
                        {
                              if(!brackFlag)
                                    brackFlag = Stack_Pop(bracketStack,RPAREN);
                              break;
                        }
                  case LCURLY:
                        {
                              Stack_Push(bracketStack,LCURLY);
                              
                              break;
                        }
                  case RCURLY:
                        {
                              if(!brackFlag)
                                    brackFlag = Stack_Pop(bracketStack,RCURLY);
                              break;
                        }
                  case LSQUARE:
                        {
                              Stack_Push(bracketStack,LSQUARE);
                              
                              break;
                        }
                  case RSQUARE:
                        {
                              if(!brackFlag)
                                    brackFlag = Stack_Pop(bracketStack,RSQUARE);
                              break;
                        }
                  case LMULTICOMMENT:
                        {
                              numTok--;
                              while(RMULTICOMMENT!=yylex()){};
                              break;
                        }
                  case NEWLINE:
                        {
                              numTok--;
                              lineNum++;
                              break;
                        }
                  case BADTOKEN:
                        {
                              numTok--;
                              printf(" on line %d\n",lineNum);
                              break;
                        }
                  case ID:
                        {
                              if(strlen(yytext)>32)
                              {
                                    numTok--;
                                    printf("ID %s too long, ID not counted\n",yytext);
                              }
                              break;
                        }
                  case STR:
                        {
                              if(strlen(yytext)>255)
                              {
                                    numTok--;
                                    printf("String Literal %s too long, String Literal not counted\n",yytext);
                              }
                              break;
                        }
                  case NUM:
                        {

                              if((atoi(yytext)<0)||(atoi(yytext)>(pow(2,32)-1)))
                              {
                                     numTok--;
                                     printf("Error invalid number\n");
                              }      
                        }

            }

      }

      printf("Total tokens: %d\n",numTok);
      printf("Main Declared: %s\n",mainFlag?"yes":"no");
      printf("All Brackets Match: %s\n",brackFlag?"no":"yes");
      return 0;
}

void Stack_Push(Stack *s, int d)
{
      if(s->size < STACK_MAX)
            s->data[s->size++] = d;
      else
            printf("STACK OVERFLOW! EVERYONE RUN!\n");

}

int Stack_Pop(Stack *s, int d)
{
      if(s->size<=0)
      {
            printf("Error stack empty\n");
            return -1;
      }
      switch(d)
      {
            case RPAREN:
                  {
                        if(s->data[s->size-1]==LPAREN)
                        {
                              s->size--;
                              return 0;
                        }
                        else
                              return 1;
                  }
            case RCURLY:
                  {
                        if(s->data[s->size-1]==LCURLY)
                        {
                              s->size--;
                              return 0;
                        }
                        else
                              return 1;
                  }
            case RSQUARE:
                  {
                        if(s->data[s->size-1]==LSQUARE)
                        {
                              s->size--;
                              return 0;
                        }
                        else
                              return 1;
                  }
            default:
                  return -1;

      }
}
